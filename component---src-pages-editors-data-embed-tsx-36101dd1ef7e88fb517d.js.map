{"version":3,"file":"component---src-pages-editors-data-embed-tsx-36101dd1ef7e88fb517d.js","mappings":"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","sources":["webpack://jacdac-docs/./src/components/blockly/dsl/workspacejson.ts","webpack://jacdac-docs/./src/pages/editors/data-embed.tsx"],"sourcesContent":["import { tidyHeaders } from \"../fields/tidy\"\nimport { BlockDataSet } from \"../toolbox\"\n\nexport interface VariableJSON {\n    // Boolean, Number, String, or service short id\n    type: string\n    id: string\n    name: string\n}\n\nexport type FieldJSON = {\n    id?: string\n    value?: number | string | boolean\n    // Boolean, Number, String, or service short id\n    variabletype?: string\n    // and extra fields, subclass\n}\n\nexport interface InputJSON {\n    type: number\n    name: string\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    fields: Record<string, FieldJSON>\n    child?: BlockJSON\n}\n\nexport interface BlockJSON {\n    type: string\n    id: string\n    children?: BlockJSON[]\n    value?: string | number | boolean\n    inputs?: InputJSON[]\n    next?: BlockJSON\n    warning?: string\n}\n\nexport function getField(block: BlockJSON, name: string): FieldJSON {\n    const inputs = block.inputs\n    for (let i = 0; i < inputs.length; ++i) {\n        const field = inputs[i].fields[name]\n        if (field) return field\n    }\n    return undefined\n}\n\nexport function getFieldValue(block: BlockJSON, name: string) {\n    const field = getField(block, name)\n    return field?.value\n}\n\nexport function resolveFieldColumn(\n    data: BlockDataSet,\n    b: BlockJSON,\n    fieldName: string,\n    options?: {\n        type?: \"string\" | \"number\" | \"boolean\"\n        required?: boolean\n    }\n): { column: string; warning?: string } {\n    const name = getFieldValue(b, fieldName) as string\n    const { type, required } = options || {}\n    const column = resolveHeader(data, name, type)\n    let warning: string\n    if (!column) {\n        if (required && !name) warning = \"missing column\"\n        else if (name) warning = `${name} column not found`\n    }\n    return { column, warning }\n}\n\nexport function resolveHeader(\n    data: BlockDataSet,\n    name: string,\n    type?: \"string\" | \"number\" | \"boolean\"\n) {\n    if (!data || !name) return undefined\n\n    const { headers } = tidyHeaders(data, type)\n    return headers.indexOf(name) > -1 ? name : undefined\n}\n\nexport interface WorkspaceJSON {\n    variables: VariableJSON[]\n    blocks: BlockJSON[]\n}\n\nexport interface WorkspaceFile {\n    editor: string\n    xml: string\n    json: WorkspaceJSON\n}\n","import React, { useRef } from \"react\"\nimport {\n    BlockJSON,\n    getFieldValue,\n    resolveFieldColumn,\n} from \"../../components/blockly/dsl/workspacejson\"\nimport DataColumnChooserField from \"../../components/blockly/fields/DataColumnChooserField\"\nimport {\n    BlockDataSet,\n    BlockDefinition,\n    BlockReference,\n    CategoryDefinition,\n    ContentDefinition,\n    DATA_SCIENCE_STATEMENT_TYPE,\n    OptionsInputDefinition,\n} from \"../../components/blockly/toolbox\"\nimport useWindowEvent from \"../../components/hooks/useWindowEvent\"\nimport { tidy, arrange, desc } from \"@tidyjs/tidy\"\nimport {\n    DslBlocksResponse,\n    DslChartExportMessage,\n    DslMessage,\n    DslTransformMessage,\n} from \"../../components/blockly/dsl/iframedsl\"\nimport { Button } from \"gatsby-material-ui-components\"\n\nexport default function Page() {\n    const frame = useRef<HTMLIFrameElement>()\n    const dslidRef = useRef<string>(undefined)\n    const colour = \"#f01010\"\n    const blocks: BlockDefinition[] = [\n        {\n            kind: \"block\",\n            type: \"iframe_random\",\n            message0: \"iframe random\",\n            colour,\n            args0: [],\n            nextStatement: DATA_SCIENCE_STATEMENT_TYPE,\n            dataPreviewField: true,\n            template: \"meta\",\n        },\n        {\n            kind: \"block\",\n            type: \"iframe_sort\",\n            message0: \"iframe arrange %1 %2\",\n            colour,\n            args0: [\n                {\n                    type: DataColumnChooserField.KEY,\n                    name: \"column\",\n                },\n                {\n                    type: \"field_dropdown\",\n                    name: \"order\",\n                    options: [\n                        [\"ascending\", \"ascending\"],\n                        [\"descending\", \"descending\"],\n                    ],\n                } as OptionsInputDefinition,\n            ],\n            previousStatement: DATA_SCIENCE_STATEMENT_TYPE,\n            nextStatement: DATA_SCIENCE_STATEMENT_TYPE,\n            dataPreviewField: true,\n            template: \"meta\",\n        },\n    ]\n    const category: ContentDefinition[] = [\n        {\n            kind: \"category\",\n            name: \"Custom\",\n            colour,\n            contents: blocks.map(\n                block => ({ kind: \"block\", type: block.type } as BlockReference)\n            ),\n        } as CategoryDefinition,\n    ]\n    const transforms: Record<\n        string,\n        (\n            b: BlockJSON,\n            dataset: BlockDataSet\n        ) => Promise<{ dataset: BlockDataSet; warning?: string }>\n    > = {\n        iframe_random: async () => {\n            console.debug(`hostdsl: random`)\n            const dataset = Array(10)\n                .fill(0)\n                .map((_, i) => ({ x: i, y: Math.random() }))\n            return { dataset }\n        },\n        iframe_sort: async (b, dataset) => {\n            console.debug(`hostdsl: sort`)\n            const { column, warning } = resolveFieldColumn(dataset, b, \"column\")\n            const order = getFieldValue(b, \"order\")\n            const descending = order === \"descending\"\n\n            console.debug(`hostdsl: sort`, {\n                b,\n                dataset,\n                column,\n                order,\n                descending,\n                warning,\n            })\n\n            if (!column) return Promise.resolve({ dataset, warning })\n            const res = tidy(\n                dataset,\n                arrange(descending ? desc(column) : column)\n            )\n            return { dataset: res, warning }\n        },\n    }\n    // eslint-disable-next-line @typescript-eslint/ban-types\n    const post = (payload: object) => {\n        frame.current.contentWindow.postMessage(payload, \"*\")\n    }\n\n    const handleBlocks = async (data: DslMessage) => {\n        const msg = { ...data, blocks, category } as DslBlocksResponse\n        post(msg)\n    }\n\n    const handleTransform = async (data: DslTransformMessage) => {\n        console.log(`hostdsl: transform`)\n        const { blockId, workspace, dataset, ...rest } = data\n        const block = workspace.blocks.find(b => b.id === blockId)\n        const transformer = transforms[block.type]\n        const res = await transformer?.(block, dataset)\n        post({ ...rest, ...(res || {}) })\n    }\n\n    const handleChartExport = async (data: DslChartExportMessage) => {\n        console.log(`hostdsl: chart export`, data)\n    }\n\n    useWindowEvent(\n        \"message\",\n        (msg: MessageEvent<DslMessage>) => {\n            const { data } = msg\n            if (data.type !== \"dsl\") return\n            const { action, dslid } = data\n            switch (action) {\n                case \"mount\":\n                    dslidRef.current = dslid\n                    break\n                case \"unmount\":\n                    dslidRef.current = dslid\n                    break\n                case \"blocks\": {\n                    handleBlocks(data)\n                    break\n                }\n                case \"chartexport\": {\n                    handleChartExport(data)\n                    break\n                }\n                case \"transform\": {\n                    handleTransform(data as DslTransformMessage)\n                    break\n                }\n            }\n        },\n        false,\n        []\n    )\n\n    const handleRefresh = () => {\n        post({ type: \"dsl\", action: \"change\", dslid: dslidRef.current })\n    }\n\n    return (\n        <>\n            <h1>Data Editor + hosted blocks</h1>\n            <p>\n                The data editor below is an example of hosted editor with\n                additional blocks injected by host (Custom category).\n            </p>\n            <p>\n                <Button\n                    title=\"Click this button to trigger a refresh\"\n                    onClick={handleRefresh}\n                >\n                    Refresh\n                </Button>\n            </p>\n            <iframe\n                ref={frame}\n                title=\"data editor\"\n                src=\"./data?embed=1\"\n                style={{\n                    border: \"none\",\n                    left: 0,\n                    top: 0,\n                    width: \"100vh\",\n                    height: \"80vh\",\n                }}\n            ></iframe>\n        </>\n    )\n}\n"],"names":["tidyHeaders","getField","block","name","inputs","i","length","field","fields","undefined","getFieldValue","value","resolveFieldColumn","data","b","fieldName","options","type","required","column","resolveHeader","warning","headers","indexOf","React","useRef","DataColumnChooserField","DATA_SCIENCE_STATEMENT_TYPE","useWindowEvent","tidy","arrange","desc","Button","Page","frame","dslidRef","colour","blocks","kind","message0","args0","nextStatement","dataPreviewField","template","KEY","previousStatement","category","contents","map","transforms","iframe_random","console","debug","dataset","Array","fill","_","x","y","Math","random","iframe_sort","order","descending","Promise","resolve","res","post","payload","current","contentWindow","postMessage","handleBlocks","msg","handleTransform","log","blockId","workspace","rest","find","id","transformer","handleChartExport","action","dslid","handleRefresh","border","left","top","width","height"],"sourceRoot":""}