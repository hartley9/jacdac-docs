{"version":3,"file":"4203-f49dcbbd72c257d00025.js","mappings":"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","sources":["webpack://jacdac-docs/./src/components/ui/WebCam.tsx"],"sourcesContent":["/* eslint-disable jsx-a11y/media-has-caption */\nimport {\n    Card,\n    CardContent,\n    CardHeader,\n    CardMedia,\n    createStyles,\n    FormControl,\n    makeStyles,\n    MenuItem,\n    Select,\n} from \"@material-ui/core\"\nimport React, {\n    ChangeEvent,\n    lazy,\n    useContext,\n    useEffect,\n    useRef,\n    useState,\n} from \"react\"\nimport useLocalStorage from \"../hooks/useLocalStorage\"\nimport useEffectAsync from \"../useEffectAsync\"\nimport SettingsIcon from \"@material-ui/icons/Settings\"\nimport IconButtonWithTooltip from \"./IconButtonWithTooltip\"\nimport useMounted from \"../hooks/useMounted\"\nimport Suspense from \"./Suspense\"\nimport CloseIcon from \"@material-ui/icons/Close\"\nimport AppContext from \"../AppContext\"\nimport { Alert } from \"@material-ui/lab\"\nconst Draggable = lazy(() => import(\"react-draggable\"))\n\nconst useStyles = makeStyles(() =>\n    createStyles({\n        cardContainer: {\n            zIndex: 1101,\n            position: \"absolute\",\n            left: \"5rem\",\n            top: \"5rem\",\n        },\n        card: {\n            \"& .hostedcontainer\": {\n                position: \"relative\",\n                width: \"30vw\",\n            },\n            \"& video\": {\n                border: \"none\",\n                position: \"relative\",\n                width: \"100%\",\n                height: \"100%\",\n            },\n        },\n    })\n)\n\nasync function requestVideoStream() {\n    // first ask for permission from ther user so that\n    // labels are populated in enumerateDevices\n    return await navigator.mediaDevices.getUserMedia({\n        audio: false,\n        video: true,\n    })\n}\n\nexport default function WebCam() {\n    const { setShowWebCam } = useContext(AppContext)\n    const [devices, setDevices] = useState<MediaDeviceInfo[]>()\n    const [deviceId, setDeviceId] = useLocalStorage(\"webcam_deviceid\", \"\")\n    const nodeRef = useRef<HTMLSpanElement>()\n    const streamRef = useRef<MediaStream>()\n    const videoRef = useRef<HTMLVideoElement>()\n    const [settingsOpen, setSettingsOpen] = useState(!deviceId)\n    const mounted = useMounted()\n    const classes = useStyles()\n\n    const handleClose = () => setShowWebCam(false)\n    const handleSettings = () => setSettingsOpen(newValue => !newValue)\n    const handleDeviceChange = (\n        ev: ChangeEvent<{ name?: string; value: unknown }>\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    ) => setDeviceId(ev.target.value as any as string)\n    const stop = () => {\n        const stream = streamRef.current\n        if (stream) {\n            try {\n                const tracks = stream.getTracks()\n                if (tracks) tracks.forEach(track => track.stop())\n            } catch (e) {\n                console.debug(e)\n            }\n            streamRef.current = undefined\n        }\n        const video = videoRef.current\n        if (video) {\n            try {\n                video.srcObject = undefined\n            } catch (e) {\n                console.debug(e)\n            }\n        }\n    }\n\n    // start camera\n    useEffectAsync(async () => {\n        console.debug(`greenscreen: start`)\n        // deviceId is \"\" if green screen selected\n        if (deviceId) {\n            console.debug(`greenscreen: stream acquired`)\n            try {\n                const stream = await navigator.mediaDevices.getUserMedia({\n                    video: { advanced: [{ deviceId: deviceId }] },\n                    audio: false,\n                })\n                streamRef.current = stream\n                const video = videoRef.current\n                video.srcObject = stream\n                video.play()\n\n                if (mounted()) setSettingsOpen(false)\n            } catch (e) {\n                console.debug(`greenscreen: play failed`)\n                console.error(e)\n                if (mounted()) setDeviceId(undefined)\n            }\n        }\n    }, [deviceId])\n\n    const updateDevices = async () => {\n        try {\n            // enumerate devices\n            const devices = await navigator.mediaDevices.enumerateDevices()\n            const webcams = devices.filter(\n                device => device.kind == \"videoinput\"\n            )\n            if (mounted()) {\n                setDevices(webcams)\n                if (!webcams.find(webcam => webcam.deviceId === deviceId)) {\n                    const did = webcams[0]?.deviceId\n                    setDeviceId(did)\n                }\n            }\n        } catch (e) {\n            if (mounted()) setDevices([])\n        }\n    }\n\n    // startup\n    useEffectAsync(async () => {\n        // first ask for permission from ther user so that\n        // labels are populated in enumerateDevices\n        await requestVideoStream()\n        await updateDevices()\n    }, [])\n\n    useEffect(() => {\n        navigator.mediaDevices.addEventListener(\"devicechange\", updateDevices)\n        return () =>\n            navigator.mediaDevices.removeEventListener(\n                \"devicechange\",\n                updateDevices\n            )\n    })\n\n    // cleanup\n    useEffect(() => stop, [deviceId])\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const draggableProps: any = {\n        nodeRef,\n    }\n\n    return (\n        <Suspense>\n            <Draggable {...draggableProps}>\n                <span ref={nodeRef} className={classes.cardContainer}>\n                    <Card className={classes.card}>\n                        <CardHeader\n                            title={\n                                settingsOpen &&\n                                devices && (\n                                    <FormControl\n                                        variant=\"outlined\"\n                                        size=\"small\"\n                                    >\n                                        <Select\n                                            title=\"select a webcam\"\n                                            open={settingsOpen}\n                                            onChange={handleDeviceChange}\n                                            value={deviceId}\n                                        >\n                                            {devices?.map(\n                                                ({ deviceId, label }) => (\n                                                    <MenuItem\n                                                        key={deviceId}\n                                                        value={deviceId}\n                                                    >\n                                                        {label}\n                                                    </MenuItem>\n                                                )\n                                            )}\n                                        </Select>\n                                    </FormControl>\n                                )\n                            }\n                            action={\n                                <>\n                                    <IconButtonWithTooltip\n                                        size=\"small\"\n                                        onClick={handleSettings}\n                                        title=\"Settings\"\n                                    >\n                                        <SettingsIcon />\n                                    </IconButtonWithTooltip>\n                                    <IconButtonWithTooltip\n                                        size=\"small\"\n                                        onClick={handleClose}\n                                        title=\"Close\"\n                                    >\n                                        <CloseIcon />\n                                    </IconButtonWithTooltip>\n                                </>\n                            }\n                        />\n                        {!devices && (\n                            <CardContent>\n                                <Alert severity=\"warning\">\n                                    Please allow access to use your camera.\n                                </Alert>\n                            </CardContent>\n                        )}\n                        <CardMedia>\n                            <div className=\"hostedcontainer\">\n                                <video\n                                    autoPlay\n                                    playsInline\n                                    ref={videoRef}\n                                    title=\"webcam\"\n                                />\n                            </div>\n                        </CardMedia>\n                    </Card>\n                </span>\n            </Draggable>\n        </Suspense>\n    )\n}\n"],"names":["Card","CardContent","CardHeader","CardMedia","createStyles","FormControl","makeStyles","MenuItem","Select","React","lazy","useContext","useEffect","useRef","useState","useLocalStorage","useEffectAsync","SettingsIcon","IconButtonWithTooltip","useMounted","Suspense","CloseIcon","AppContext","Alert","Draggable","useStyles","cardContainer","zIndex","position","left","top","card","width","border","height","requestVideoStream","navigator","mediaDevices","getUserMedia","audio","video","WebCam","setShowWebCam","devices","setDevices","deviceId","setDeviceId","nodeRef","streamRef","videoRef","settingsOpen","setSettingsOpen","mounted","classes","handleClose","handleSettings","newValue","handleDeviceChange","ev","target","value","stop","stream","current","tracks","getTracks","forEach","track","e","console","debug","undefined","srcObject","advanced","play","error","updateDevices","enumerateDevices","webcams","filter","device","kind","find","webcam","did","addEventListener","removeEventListener","draggableProps","map","label"],"sourceRoot":""}