{"version":3,"file":"661-97e8f3f9be9f4d9a65f7.js","mappings":"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","sources":["webpack://jacdac-docs/./src/components/blockly/fields/TwinWidget.tsx","webpack://jacdac-docs/./src/components/hooks/useBestRegister.ts"],"sourcesContent":["import React, { useContext, useRef } from \"react\"\nimport { Grid } from \"@mui/material\"\nimport DashboardServiceWidget from \"../../dashboard/DashboardServiceWidget\"\nimport WorkspaceContext from \"../WorkspaceContext\"\nimport NoServiceAlert from \"./NoServiceAlert\"\nimport { PointerBoundary } from \"./PointerBoundary\"\nimport useBestRegister from \"../../hooks/useBestRegister\"\nimport { useEffect } from \"react\"\nimport { REPORT_UPDATE } from \"../../../../jacdac-ts/src/jdom/constants\"\nimport useBlockData from \"../useBlockData\"\nimport JacdacContext, { JacdacContextProps } from \"../../../jacdac/Context\"\nimport { toMap } from \"../../../../jacdac-ts/src/jdom/utils\"\n\nconst DEFAULT_HORIZON = 30 // 10 seconds\nexport default function TwinWidget() {\n    const { bus } = useContext<JacdacContextProps>(JacdacContext)\n    const { twinService, flyout, sourceBlock } = useContext(WorkspaceContext)\n    const { data, setData } = useBlockData(sourceBlock, [], 50)\n    const currentDataRef = useRef<{ time: number }[]>([])\n\n    // data collection\n    const register = useBestRegister(twinService)\n    const setRegisterData = () => {\n        const newValue = register?.unpackedValue\n        if (newValue !== undefined) {\n            const newRow = toMap(\n                register.fields,\n                f => f.name,\n                (f, i) => newValue[i]\n            )\n            const now = bus.timestamp / 1000\n            const rowTime = register.lastDataTimestamp / 1000\n            const outdated = now - DEFAULT_HORIZON\n            const currentData = currentDataRef.current\n            const newData = [\n                ...(currentData || []).filter(d => d.time >= outdated),\n                {\n                    time: rowTime,\n                    ...newRow,\n                },\n            ]\n            currentDataRef.current = newData\n            setData(newData)\n        }\n    }\n    useEffect(\n        () => register?.subscribe(REPORT_UPDATE, setRegisterData),\n        [register]\n    )\n    useEffect(() => {\n        currentDataRef.current = data\n    }, [sourceBlock])\n\n    if (flyout) return null\n    if (!twinService) return <NoServiceAlert />\n\n    return (\n        <Grid\n            container\n            alignItems=\"center\"\n            alignContent=\"center\"\n            justifyContent=\"center\"\n            spacing={1}\n        >\n            <Grid item>\n                <PointerBoundary>\n                    <DashboardServiceWidget\n                        service={twinService}\n                        visible={true}\n                        variant=\"icon\"\n                    />\n                </PointerBoundary>\n            </Grid>\n        </Grid>\n    )\n}\n","import { useMemo } from \"react\"\nimport { SystemReg } from \"../../../jacdac-ts/jacdac-spec/dist/specconstants\"\nimport JDService from \"../../../jacdac-ts/src/jdom/service\"\nimport {\n    isReading,\n    isValue,\n    isValueOrIntensity,\n} from \"../../../jacdac-ts/src/jdom/spec\"\n\nexport default function useBestRegister(service: JDService) {\n    return useMemo(() => {\n        const specification = service?.specification\n        const hasReading = specification?.packets.some(reg => isReading(reg))\n        if (hasReading) return service.register(SystemReg.Reading)\n        const hasValue = specification?.packets.some(reg => isValue(reg))\n        if (hasValue) return service.register(SystemReg.Value)\n        const hasIntensity = specification?.packets.some(reg =>\n            isValueOrIntensity(reg)\n        )\n        if (hasIntensity) return service.register(SystemReg.Intensity)\n        return undefined\n    }, [service])\n}\n"],"names":["React","useContext","useRef","Grid","DashboardServiceWidget","WorkspaceContext","NoServiceAlert","PointerBoundary","useBestRegister","useEffect","REPORT_UPDATE","useBlockData","JacdacContext","toMap","DEFAULT_HORIZON","TwinWidget","bus","twinService","flyout","sourceBlock","data","setData","currentDataRef","register","setRegisterData","newValue","unpackedValue","undefined","newRow","fields","f","name","i","now","timestamp","rowTime","lastDataTimestamp","outdated","currentData","current","newData","filter","d","time","subscribe","useMemo","SystemReg","isReading","isValue","isValueOrIntensity","service","specification","hasReading","packets","some","reg","Reading","hasValue","Value","hasIntensity","Intensity"],"sourceRoot":""}